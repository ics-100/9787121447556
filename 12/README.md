

# 第 11 章 进入保护模式

## 11.2 全局描述符表

* 和一个段有关的信息需要 `8个字` 节来描述，所以称为段描述符（Segment Descriptor）
* 最主要的描述符表是全局描述符表（Global Descriptor Table， `GDT`）
* 为了跟踪全局描述符表，处理器内部有一个 `48` 位的寄存器，称谓全局描述符表寄存器（`GDTR`）
* `32` 位线性基地址保存的是全局表述符表在内存中的起始线性地址
* `16` 位边界部分保存的是全局描述符表的边界，其数值上等于表的大小（总字节数）减一。界限值就是表内最后 1 字节的偏移量
* 由于在实模式下只能访问 1MB的内存，故 GDT通常都定义在 1MB以下的内存范围中

### 11.3 存储器的段描述符


* 下面是低 32 位， 上面是高 32 位
* 在 32 位保护模式下，段地址是 32 位的线性地址，如果未开启分页功能，该线性地址就是物理地址


<img src="./01.png" />

<img src="./02.png" />



### 11.4 安装存储器的段描述符并加载GDTR

* 必须将GDT的线性地址转换成逻辑段地址和偏移地址
* 处理器规定， GDT 中的第一个描述符必须是空描述符
* `lgdt m48` 操作数是一个 48 位的内存区域: 低16 是界限值，高 32 位是基地址

### 11.5 关于第 21 条地址线 A20 的问题

* 端口: `0x92` 的位 1 用于控制 A20， 叫做 Fast A20


### 11.6 保护模式下的内存访问

* 控制这两种模式切换的开关原是在一个叫 CR0 的寄存器， 它的第一位（位0）是保护模式的允许位
* 每个段寄存器包括了一个不可见的部分，称为描述符高速缓存器, 用来存放段的线性基地址、段界限和段属性
* 在保护模式下，尽管访问内存时也需要指定一个段，但传送到段选择器的内容不是逻辑段地址，而是段描述符在描述符表中的索引
* 描述符在表内的偏移地址是索引号乘以 8 

<img src="./03.png" />

### 11.7 清空流水线并串行优化处理器


* 处理器最怕转移指令，遇到这种指令，一般会清空流水线，并串行优化; 另一方面，远转移会重新加载段选择器 CS， 并刷新描述符高速缓存器中的内容
* 一个建议的方法是在设置了控制寄存器CR0的PE位之后，立即用jmp或者call转移到当前指令流的下一条质量上
* `[bits 32]`

## Ref

* [「Coding Master」第28话 从实模式到保护模式的切换代码](https://www.youtube.com/watch?v=EkzleCAIdXg&list=PLLBMaJy_MOpM2xUPbjSBSib7hUUaaEGa6&index=30)