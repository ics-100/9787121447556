# 第 6 章 编写主引导扇区代码

|本期版本|上期版本|
|:---:|:---:|
|`Wed Mar 20 14:49:12 CST 2024`| -

## 6.2 欢迎来到主引导扇区

* 一个有效的主引导扇区，其最后两字节应当是 `0x55` 和 `0xAA`

## 6.3 注释

* 注释必须以英文字母 `;` 开始

### 6.4.1 显卡和显存

* 所有在个人计算机上使用的显卡，在加电自检之后都会把自己初始化到 `80 x 25` 的文本模式
* 在这种模式下，屏幕上可以显示25行，每行80个字符，每屏总共2000个字符
* 一直以来， `0xB8000~0xBFFFF` 这段物理地址空间，是留给显卡的


### 6.4.2 初始化段寄存器

* Intel 的处理器不能允许将一个立即数传送到段寄存器

### 6.4.3 显存的访问和ASCII代码

* ASCII 是7位代码，只用了一个字节中的低7比特，最高位通常置0。
* ASCII 表中有相当一部分代码是不可打印和显示的，它们用于控制通信过程。
* 数字5和字符5不同的，**显卡在任何时候都认为你发送的是ASCII码**
* 屏幕上的每个字符对应着显存中的**2个连续字节**，前一个是字符的**ASCII代码**，后面是字符的**显示属性**
* 字符的显示属性分为两部分，低 4 位定义了**前景色**，高4位定义的是**背景色**


### 6.4.4 显示字符

* 多数汇编语言编译器允许在指令中直接使用字符的字面值来代替数值形式的ASCII码
* 在源程序的编译阶段，汇编语言编译器会将它转换成ASCII码的形式
* 一般情况下，如果没有附加任何指示，段地址默认在段寄存器DS中
* 段超越前缀 `es:` 明确要求处理器生成物理地址是，使用段寄存器ES, 而不是默认的段寄存器DS
* 目的操作数必须用`方括号`围起来，以表明它是一个地址
* 关键字 `byte` 用来修饰目的操作数，指出本次传送是以字节的方式进行的

## 6.5  显示标号的汇编地址

### 6.5.1  标号

* 汇编地址： 该指令相对于程序或者段起始处的距离，以字节计。
* 在NASM汇编语言里，每条指令的前面都可以拥有一个编号，以代表和指示该指令的汇编地址
* **标号之后的冒号是可选的**
* 标号并不是必须的，只有在我们需要引用某条指令的汇编地址时，才使用标号

```nasm
nasm -l exam.lst
```

* 汇编器输出的 `.lst` 列表文件通常只是一个初步的编译结果，还需要后续处理，所以这个文件并不能反映编译后的结果，
* 与编译后的结果可能会有出入，在分析程序的结果时，不要完全依赖于这个文件，而要以实际的编译结果为准

### 6.5.2 如何显示十进制数字

* 只要把 AX 的内容不停地除以 10， 只需要 5 次，把每次的余数反向组合到一起，就是原来的数字
* 把每次相除得到余数加上 `0x30`, 在屏幕上显示就没问题了


### 6.5.3 在程序中声明并初始化数据

* 要放在程序中的数据用 DB 指令来声明的，DB的意思是声明字节(Declare Byte)
* `Byte`、`Word`、`Double Word`、`Quad Word`
* DB、DW、DD、DQ不是处理器指令，它只是编译器提供的汇编指令，所以称作伪指令
* 伪指令是汇编指令的一种，它没有对应的机器指令，所以它不是机器指令的助记符，仅仅在编译阶段由编译器执行，编译成功后，伪指令就消失了


### 6.5.4 分解数的各个数位


* 16位除以8位: `AX(被除数)`、`[R|M]8(除数)`、`AL(商)`、`AH(余数)`
* 32位除以16位: `DX(高16位):AX(低16位)/被除数`、`[R|M]16(除数)`、`AX(商)`、`DX(余数)`
* 因为除数是10， 余数自然比10小，我们可以在 `DL` 中取得
  
### 6.5.5 显示分解出来的各个数位

* 在分解并保存各个数位的时候，顺序是“个、十、百、千、万”, 当在屏幕上显示是，却要反过来，先显示万位、在显示千位
* 将 `AL` 中的内容加上 `0x30`， 以得到与该数字对应的 ASCII 代码

## 6.6 使程序进入无限循环状态

* 取得指令，然后执行，同时把 IP 的内容加上当前指令的长度，以指向吓一跳指令的偏移地址

**相对近转移**

* 目标位置相对于当前指令处的偏移量(以字节为单位)
* 这种转移是相对的，操作数是一个相对量。
* 关键字 `near` 不是最主要的，它仅仅用于指示相对量是16位的

## 6.7 完成并编译主引导扇区代码


* 伪指令 `times` 可用于重复它后面的指令若干次

```bash
# (512-2 - 307)D - 0x133  = 203D
nasm c06_mbr.asm -f bin -l c06_mbr.lst -o c06_mbr.bin
```


## 6.9 程序的调试技术

### 6.9.2 Bochs 下的程序调试入门

* 现代处理器在加电启动时，段寄存器 CS 的内容为 `0xF000`, 指令指针寄存器 IP 的内容为 `0xFFF0`
* 在刚刚启动时，处理器将其余（高位部分）的地址线强制位高电平